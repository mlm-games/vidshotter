name: Release

on:
  workflow_dispatch:
    inputs:
      version_bump:
        description: "Version bump type"
        required: true
        default: "patch"
        type: choice
        options:
          - patch
          - minor
          - major
      mark_prerelease:
        description: "Mark as prerelease"
        required: false
        default: false
        type: boolean

permissions:
  contents: write

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

jobs:
  prepare-version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.bump.outputs.version }}
      commit_sha: ${{ steps.commit.outputs.commit_sha }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Bump version in Cargo.toml
        id: bump
        shell: bash
        run: |
          set -euo pipefail
          CARGO_TOML="Cargo.toml"
          BUMP_TYPE="${{ inputs.version_bump || 'patch' }}"
          
          # Extract current version
          OLD_VERSION=$(grep -m1 '^version\s*=\s*"' "$CARGO_TOML" | sed -E 's/.*"([^"]+)".*/\1/')
          if [[ -z "$OLD_VERSION" ]]; then
            echo "::error::Could not detect version in Cargo.toml"
            exit 1
          fi
          
          IFS='.' read -r MAJ MIN PAT <<< "$OLD_VERSION"
          : "${MAJ:=0}" "${MIN:=0}" "${PAT:=0}"
          
          case "$BUMP_TYPE" in
            major) NEW_VERSION="$((MAJ+1)).0.0" ;;
            minor) NEW_VERSION="$MAJ.$((MIN+1)).0" ;;
            patch) NEW_VERSION="$MAJ.$MIN.$((PAT+1))" ;;
            *)     echo "::error::Invalid bump type: $BUMP_TYPE"; exit 1 ;;
          esac
          
          sed -i -E "0,/^version\s*=.*/s//version = \"$NEW_VERSION\"/" "$CARGO_TOML"
          
          # Also update version in main.rs Args struct if present
          if grep -q 'version = "' src/main.rs; then
            sed -i -E "s/version = \"[0-9]+\.[0-9]+\.[0-9]+\"/version = \"$NEW_VERSION\"/" src/main.rs
          fi
          
          echo "version=$NEW_VERSION" >> "$GITHUB_OUTPUT"
          echo "Bumped version: $OLD_VERSION -> $NEW_VERSION ($BUMP_TYPE)"

      - name: Update Cargo.lock
        run: cargo update -w

      - name: Commit and create tag
        id: commit
        shell: bash
        run: |
          set -e
          VERSION="${{ steps.bump.outputs.version }}"
          TAG="v$VERSION"
          
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git config user.name "github-actions[bot]"
          
          git add Cargo.toml Cargo.lock src/main.rs || git add Cargo.toml Cargo.lock
          git commit -m "chore: bump to $TAG [skip ci]"
          git push
          
          git tag -a "$TAG" -m "Release $TAG"
          git push origin "$TAG"
          
          echo "commit_sha=$(git rev-parse HEAD)" >> "$GITHUB_OUTPUT"
          echo "Created tag: $TAG"

  linux:
    needs: prepare-version
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ needs.prepare-version.outputs.commit_sha }}
      - uses: dtolnay/rust-toolchain@stable
      - run: cargo build --release
      - run: strip target/release/vidshotter
      - uses: actions/upload-artifact@v4
        with:
          name: vidshotter-linux-x86_64
          path: target/release/vidshotter

  linux-musl:
    needs: prepare-version
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ needs.prepare-version.outputs.commit_sha }}
      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-unknown-linux-musl
      - run: sudo apt-get update && sudo apt-get install -y musl-tools
      - run: cargo build --release --target x86_64-unknown-linux-musl
      - run: strip target/x86_64-unknown-linux-musl/release/vidshotter
      - uses: actions/upload-artifact@v4
        with:
          name: vidshotter-linux-musl-x86_64
          path: target/x86_64-unknown-linux-musl/release/vidshotter

  windows:
    needs: prepare-version
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ needs.prepare-version.outputs.commit_sha }}
      - uses: dtolnay/rust-toolchain@stable
      - run: cargo build --release
      - uses: actions/upload-artifact@v4
        with:
          name: vidshotter-windows-x86_64
          path: target/release/vidshotter.exe

  macos-intel:
    needs: prepare-version
    runs-on: macos-13
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ needs.prepare-version.outputs.commit_sha }}
      - uses: dtolnay/rust-toolchain@stable
      - run: cargo build --release
      - run: strip target/release/vidshotter
      - uses: actions/upload-artifact@v4
        with:
          name: vidshotter-macos-x86_64
          path: target/release/vidshotter

  macos-arm:
    needs: prepare-version
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ needs.prepare-version.outputs.commit_sha }}
      - uses: dtolnay/rust-toolchain@stable
      - run: cargo build --release
      - run: strip target/release/vidshotter
      - uses: actions/upload-artifact@v4
        with:
          name: vidshotter-macos-aarch64
          path: target/release/vidshotter

  release:
    needs: [prepare-version, linux, linux-musl, windows, macos-intel, macos-arm]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release assets
        run: |
          mkdir -p release
          
          # Linux x86_64 (glibc)
          cp artifacts/vidshotter-linux-x86_64/vidshotter release/vidshotter-linux-x86_64
          chmod +x release/vidshotter-linux-x86_64
          
          # Linux x86_64 (musl - static)
          cp artifacts/vidshotter-linux-musl-x86_64/vidshotter release/vidshotter-linux-musl-x86_64
          chmod +x release/vidshotter-linux-musl-x86_64
          
          # Windows
          cp artifacts/vidshotter-windows-x86_64/vidshotter.exe release/vidshotter-windows-x86_64.exe
          
          # macOS Intel
          cp artifacts/vidshotter-macos-x86_64/vidshotter release/vidshotter-macos-x86_64
          chmod +x release/vidshotter-macos-x86_64
          
          # macOS ARM
          cp artifacts/vidshotter-macos-aarch64/vidshotter release/vidshotter-macos-aarch64
          chmod +x release/vidshotter-macos-aarch64
          
          # Generate checksums
          cd release
          sha256sum * > SHA256SUMS.txt
          cat SHA256SUMS.txt

      - uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.prepare-version.outputs.version }}
          name: v${{ needs.prepare-version.outputs.version }}
          target_commitish: ${{ needs.prepare-version.outputs.commit_sha }}
          generate_release_notes: true
          prerelease: ${{ inputs.mark_prerelease || false }}
          body: |
            ## Installation
            
            ### Prerequisites
            - FFmpeg must be installed and available in your PATH
            
            ### Download
            Choose the appropriate binary for your platform:
            - **Linux (glibc)**: `vidshotter-linux-x86_64`
            - **Linux (static/musl)**: `vidshotter-linux-musl-x86_64`
            - **Windows**: `vidshotter-windows-x86_64.exe`
            - **macOS Intel**: `vidshotter-macos-x86_64`
            - **macOS Apple Silicon**: `vidshotter-macos-aarch64`
            
            ### Quick Start
            ```bash
            # Extract 30 screenshots from a video
            vidshotter -i video.mp4
            
            # Extract 50 screenshots as JPG
            vidshotter -i video.mp4 -n 50 -f jpg
            ```
            
            See [README](https://github.com/mlm-games/vidshotter#readme) for full usage.
          files: |
            release/vidshotter-linux-x86_64
            release/vidshotter-linux-musl-x86_64
            release/vidshotter-windows-x86_64.exe
            release/vidshotter-macos-x86_64
            release/vidshotter-macos-aarch64
            release/SHA256SUMS.txt